#!/usr/bin/env bash

set -o errexit
set -o errtrace

datahome="${XDG_DATA_HOME:-$HOME/.local/share}"
datahome="$datahome/hackenv"

shared="$(realpath "$datahome/shared")"

printf "Trying to fix SElinux labels...\n" >&2

if ! command -v semanage &> /dev/null; then
	printf "SElinux coreutils binaries could not be found.\n" >&2
	command -v yum &> /dev/null &&
		sudo yum -y install policycoreutils-python-utils ||
		printf "Exiting.\n" >&2
	exit 0
fi

printf "Setting permissions for shared directory...\n" >&2

mkdir -p "$shared"
chmod 770 "$shared"
sudo semanage fcontext "$shared(/.*)?" --deleteall
sudo semanage fcontext -a -t svirt_image_t "$shared(/.*)?"
sudo restorecon -vrF "$shared"

for cdrom in kali.iso parrot.iso; do
	path="$(realpath "$datahome/$cdrom")"

	if ! [ -f "$path" ]; then
		continue
	fi

	printf "Setting permissions for image %s...\n" "$cdrom" >&2

	sudo semanage fcontext "$path" --deleteall
	sudo semanage fcontext -a -t svirt_image_t "$path"
	sudo restorecon -vrF "$path"
done
